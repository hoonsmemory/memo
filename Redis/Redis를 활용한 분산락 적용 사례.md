## Redis를 활용한 분산락 적용 사례
기존 서비스에서는 주문할 때 재고 수량의 검증을 엄격하게 다루지 않았다.  
부족한 재고는 각 입점사에게 연락하여 재고가 있을 경우 **배송 준비 중**으로 주문 상태를 변경하였고, 재고가 없을 경우 **주문 취소**를 하였다.  
이러한 프로세스는 고객으로부터 많은 컴플레인을 받아왔고, MD 파트, CS 파트의 업무 불만도 높은 상태였다.  
위 문제를 해결하기 위해 분산락을 활용하여 주문서 생성 시 재고 검증을 하게 되었고, 재고 관련한 이슈를 해결할 수 있었다.    
<br>

### 해결 방법
**SELECT ... FOR UPDATE 활용**  
```sql
SELECT s.*
  FROM stocks s
 WHERE s.product_id = ?
   FOR UPDATE;
```
SELECT ... FOR UPDATE 은 데이터베이스에서 특정 행을 읽으면서 동시에 배타적 락을 설정하는 SQL 구문이다.  
이 구문은 테이블 전체가 아닌, WHERE 조건에 따라 반환된 **특정 행만 락의 대상**이 된다.  
오라클 기준 기본 옵션은 락을 획득하지 못 한 커넥션은 락을 점유중인 커넥션이 트랜잭션을 종료할 때까지 대기한다.  
WAIT 혹은 NOWAIT 옵션을 적용해 락을 일정시간동만 기다리게 처리할 수도 있다.  
<br>

**Redis 활용**  
```sql
SET key value NX EX seconds
```
Redis의 SET 명령어는 NX와 EX 옵션을 함께 사용하여 분산락을 구현할 수 있는 강력한 방법을 제공한다.  
NX 옵션은 키가 존재하지 않을 때만 값을 설정하도록 보장하며, EX 옵션은 TTL값을 설정하여 락의 유효 기간을 제한한다.  

그 외에 다양한 방법들이 있지만 장단점을 따져보고 최종적으로 Redis를 사용하기로 결정했다.  
<br>

### Redisson 사용  
![스크린샷 2024-12-02 오후 4 59 40](https://github.com/user-attachments/assets/80be33e7-5533-46a8-831e-6c7ff7e9e9d0)
Redisson은 스프링 환경에서 분산락을 사용할 수 있도록 구현된 클라이언트다.  
코드를 직접 구현해서 적용해도 되지만, 꾸준히 릴리즈되고 있는 버전과 성능을 최적화하고 있는 Redisson을 사용하기로 결정했다.  

대표 메서드는 tryLock()이 있으며 락을 대기할 시간과 점유할 시간을 입력하면 락을 획득할 수 있다.  
내부 코드에서는 Lua Script가 작성되어 있으며 락 설정 가능 여부 확인, 락 설정 또는 재진입 처리, 락 획득 실패 시 TTL 반환의 로직을 담고 있다.  
<br>

















